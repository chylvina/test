window.aliyun_config={ENV_LIST:{rnd:0,qianniu:1},ENV:0,REFRESH_INTERVAL:3e4,PARAMS:{currentPage:0,pageSize:10}},angular.module("ecsApp",["ui.router","ngCookies","pasvaz.bindonce","app.service.instance","app.service.config","app.directive.instance-overview","app.directive.loading","angular.directive.pull-to-refresh","angular-highcharts","app.directive.isroll","ngAnimate","app.filter.instance","angular.directive.tap","app.tpl"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.when("/c?id","/contacts/:id").when("/user/:id","/contacts/:id").otherwise("/"),a.state("region",{url:"/:regionID",views:{container:{templateUrl:"views/instances.html",controller:["$scope","$state","$stateParams","instanceService","dateService","appConfig","$rootScope",function(a,b,c,d,e,f,g){a.regions=d.data.regions,a.instances=d.data.instances,a.toggle=function(a){"region"==b.current.name?b.go(".instance",{instanceID:a.instanceId}):"region.instance"==b.current.name&&(a.instanceId==b.params.instanceID?b.go("^"):b.go("region.instance",{instanceID:a.instanceId}))},a.loadNext=function(){a.pullToRefreshLoadStatus="loading",d.update_region_instance_next(c.regionID).then(function(){},function(){a.pullToRefreshLoadStatus="error"})},a.getStatusInfo=function(a){var b="";if("Released"==a.status)b='<span class="text-gray">已释放</span>';else if("Expired"==a.status&&"AfterPay"!=a.chargeType)b=0==a.toReleaseDays?'<span class="text-orange">即将释放</span>':'还有<span class="text-orange">'+a.toReleaseDays+"</span>天释放";else if("AfterPay"==a.chargeType)b="创建时间: "+a.createTime;else{var c=a.toExpireDays>7?"text-green":"text-orange";b=0==a.toExpireDays?'<span class="'+c+'">即将到期</span>':'<span class="'+c+'">'+a.toExpireDays+"</span>天后到期"}return b};var h=function(){a.loading="loading",d.update_region_instance(c.regionID).then(function(){a.loading="done",c.regionID&&""!=c.regionID?a.instanceMax=d.data.regions["max_"+c.regionID]:d.data.regions.list.length>0&&b.go("region",{regionID:d.data.regions.list[0].regionId})},function(){a.loading="error";var b=a.$on("reload",function(){b(),h(),g.$$phase?scope.$eval():a.$apply()})})};h()}]}}}).state("region.instance",{url:"/:instanceID"}).state("region.instance.detail",{url:"/detail",views:{"detail@region":{templateUrl:"views/detail.html",controller:["$scope","$state","$stateParams","instanceService",function(a,b,c,d){var e=function(){a.detail_render=0,a.detail_loading="loading",d.update_detail(c.instanceID).then(function(){a.detail_render=1,a.detail_loading="done",a.ins=d.data.detail.data},function(){a.detail_loading="error";var b=a.$on("reload",function(){b(),e(),$rootScope.$$phase?scope.$eval():a.$apply()})})};e()}]}}}).state("region.instance.chart",{url:"/chart/:chartType",views:{"chart@region":{templateUrl:"views/chart.html",controller:["$scope","$state","$stateParams","instanceService",function(a,b,c,d){a.fullChartConfig=d.data.monitor.full[c.chartType],a.render=0,a.isLoading="loading",a.fullChartStyle={width:window.innerHeight-0+"px",height:window.innerWidth-0+"px","margin-top":(window.innerHeight-window.innerWidth)/2+"px","margin-left":(window.innerWidth-window.innerHeight)/2+"px"};var e=function(){a.chart_render=0,a.chart_loading="loading",d.update_monitor(c.instanceID).then(function(){a.chart_render=1,a.chart_loading="done"},function(){a.chart_loading="error";var b=a.$on("reload",function(){b(),e(),$rootScope.$$phase?scope.$eval():a.$apply()})})};e()}]}}})}]).run(["$rootScope","$state","$stateParams",function(a,b,c){a.$state=b,a.$stateParams=c}]),angular.module("app.service.config",["aliyun.service.request"]).config(["$provide",function(a){if(!window.aliyun_config)throw new Error("aliyun config lost.");a.value("appConfig",window.aliyun_config)}]).factory("aliyun_request",["appConfig","jsonRequest","qnRequest",function(a,b,c){switch(a.ENV){case a.ENV_LIST.rnd:return b;case a.ENV_LIST.qianniu:return c;default:throw new Error("aliyun config broken.")}}]),angular.module("app.service.instance",["angular.service.date","app.service.config"]).factory("instanceService",["aliyun_request","$q","$rootScope","dateService","$timeout","appConfig",function(a,b,c,d,e,f){var g={base:{chart:{height:160,type:"area",backgroundColor:!1},plotOptions:{series:{enableMouseTracking:!1}},legend:{enabled:!1},xAxis:{tickLength:0,lineColor:"#2c3348",labels:{style:{color:"#8697a7"}}},yAxis:{gridLineColor:"#2c3348",labels:{style:{color:"#8697a7"}}}},cpu:{yAxis:{max:100},colors:["#FFFFFF"]},flow:{colors:["#FFFFFF"]},bps:{colors:["#FFFFFF"]}},h={base:{chart:{height:window.innerWidth-40,type:"area",backgroundColor:!1},plotOptions:{series:{enableMouseTracking:!1}},legend:{backgroundColor:"#484e60",borderColor:"#484e60",borderWidth:1,borderRadius:0,itemStyle:{color:"#FFF"},itemHiddenStyle:{color:"#AAA"},symbolPadding:0,symbolWidth:0,symbolHeight:0,symbolRadius:0,labelFormatter:function(){return this.legendSymbol.element.outerHTML="",this.name}},xAxis:{tickLength:0,lineColor:"#2c3348",symbolRadius:0,labelFormatter:function(){return this.legendSymbol.element.outerHTML="",this.name},labels:{style:{color:"#8697a7"}}},yAxis:{gridLineColor:"#2c3348",labels:{style:{color:"#8697a7"}}}},cpu:g.cpu,flow:g.flow,bps:g.bps},i={lastModified:0,mini:{cpu:jQuery.extend(!0,angular.copy(g.base),g.cpu),flow:jQuery.extend(!0,angular.copy(g.base),g.flow),bps:jQuery.extend(!0,angular.copy(g.base),g.bps)},full:{cpu:jQuery.extend(!0,angular.copy(h.base),h.cpu),flow:jQuery.extend(!0,angular.copy(h.base),h.flow),bps:jQuery.extend(!0,angular.copy(h.base),h.bps)}},j={cpu:[[139444278e4,76],[139444284e4,53],[13944429e5,41],[139444296e4,45],[139444302e4,30],[139444308e4,68],[139444314e4,69],[13944432e5,45],[139444326e4,42],[139444332e4,41]],flow:{i:[[139444278e4,76],[139444284e4,53],[13944429e5,41],[139444296e4,45],[139444302e4,30],[139444308e4,68],[139444314e4,69],[13944432e5,45],[139444326e4,42],[139444332e4,41]],o:[[139444278e4,12],[139444284e4,31],[13944429e5,24],[139444296e4,31],[139444302e4,13],[139444308e4,17],[139444314e4,25],[13944432e5,31],[139444326e4,17],[139444332e4,24]]},bps:{r:[[139444278e4,12],[139444284e4,31],[13944429e5,24],[139444296e4,31],[139444302e4,13],[139444308e4,17],[139444314e4,25],[13944432e5,31],[139444326e4,17],[139444332e4,24]],w:[[139444278e4,76],[139444284e4,53],[13944429e5,41],[139444296e4,45],[139444302e4,30],[139444308e4,68],[139444314e4,69],[13944432e5,45],[139444326e4,42],[139444332e4,41]]}};i.mini.cpu.series=i.full.cpu.series=[{name:"CPU使用率",data:j.cpu}],i.mini.flow.series=i.full.flow.series=[{name:"入网",data:j.flow.i},{name:"出网",data:j.flow.o}],i.mini.bps.series=i.full.bps.series=[{name:"读",data:j.bps.r},{name:"写",data:j.bps.w}];var k={};k.data={monitor:i,instances:{},regions:{lastModified:0,list:[]},detail:{lastModified:0,data:{}}};var l=f.PARAMS,m=a;return k.update_region_instance=function(a){function c(b){m({method:"GET",url:"instance.json",param:{regionId:b,currentPage:l.currentPage,pageSize:l.pageSize}}).then(function(b){var c=[];b.data.forEach(function(b){b.lastModified=d.getTime(),a&&""!=a?b.regionId==a&&(c.push(b),k.data.instances[b.regionId]=c):b.regionId==k.data.regions.list[0].regionId&&(c.push(b),k.data.instances[b.regionId]=c)}),e.resolve()},function(a){console.log("error  "+a),e.reject()})}var e=b.defer();return 0==k.data.regions.lastModified||d.toNow(k.data.regions.lastModified)>f.REFRESH_INTERVAL?m({method:"GET",url:"region.json"}).then(function(b){var e;k.data.regions.lastModified=d.getTime(),k.data.regions.list=[],b.data.regions.forEach(function(a,b){0!=a.ecs&&(23!=a.regionId?k.data.regions.list[b]=a:23==a.regionId&&k.data.regions.list.unshift(a),k.data.regions["max_"+a.regionId]=a.ecs)}),e=a&&""!=a?a:k.data.regions.list[0].regionId,c(e)},function(a){console.log("error"+a,"========================"),e.reject(a)}):k.data.regions.list.length>0&&void 0==k.data.instances[a]?c(a):e.resolve(),e.promise},k.update_region_instance_next=function(a){var c=b.defer();return l.currentPage+=1,m({method:"GET",url:"instance.json",param:{regionId:a,currentPage:l.currentPage,pageSize:l.pageSize}}).then(function(b){k.data.instances.lastModified=d.getTime(),b.data.forEach(function(b){b.lastModified=d.getTime(),b.regionId==a&&k.data.instances[a].push(b)}),c.resolve()},function(a){console.log("error  "+a),c.reject(a)}),c.promise},k.update_monitor=function(a,c){var e=b.defer();return 0==k.data.monitor.lastModified||d.toNow(k.data.monitor.lastModified)>f.REFRESH_INTERVAL?m({method:"GET",url:"monitor.json",param:{instanceId:a,period:c||"halfhour"}}).then(function(b){i.lastModified=i.mini.lastModified=i.full.lastModified=d.getTime(),i.instanceId=a,i.mini.cpu.series[0].data=i.full.cpu.series[0].data=b.data.cpuSeries,i.mini.flow.series[0].data=i.full.flow.series[0].data=b.data.flowRxSeries,i.mini.flow.series[1].data=i.full.flow.series[1].data=b.data.flowTxSeries,i.mini.bps.series[0].data=i.full.bps.series[0].data=b.data.bpsReadSeries,i.mini.bps.series[1].data=i.full.bps.series[1].data=b.data.bpsWriteSeries,console.log(k.data.monitor,"********************************"),e.resolve()},function(a){console.log("error "+a),e.reject()}):e.resolve(),e.promise},k.update_detail=function(a){var c=b.defer();return 0==k.data.detail.lastModified||d.toNow(k.data.detail.lastModified)>f.REFRESH_INTERVAL?m({method:"GET",url:"detail.json",param:{instanceId:a}}).then(function(a){k.data.detail.lastModified=d.getTime(),k.data.detail.data={},k.data.detail.data=a.data,c.resolve()},function(a){console.log("error "+a),c.reject()}):c.resolve(),c.promise},k.get_instance=function(a,b){if(!a||!b)return!1;if(!k.data.instances[a])return!1;for(var c=k.data.instances[a],d=c.length;d--;){var e=c[d];if(e.instanceId==b)return c[d]}},k}]),angular.module("angular.service.date",[]).factory("dateService",["$rootScope",function(){var a={};return a.getTime=function(){return(new Date).getTime()},a.toNow=function(b){return a.getTime()-b},a}]),angular.module("app.directive.instance-overview",["app.service.instance","angular-highcharts"]).controller("overviewController",["$scope","instanceService","$rootScope",function(a,b,c){a.miniChartConfig=b.data.monitor.mini,a.fullChartConfig=b.data.monitor.full,a.fullChartStyle={width:window.innerHeight-0+"px",height:window.innerWidth-0+"px","margin-top":(window.innerHeight-window.innerWidth)/2+"px","margin-left":(window.innerWidth-window.innerHeight)/2+"px"};var d=function(){a.overview_render=0,a.overview_loading="loading",b.update_monitor().then(function(){a.overview_render=1,a.overview_loading="done"},function(){a.overview_loading="error";var b=a.$on("reload",function(){b(),d(),c.$$phase?scope.$eval():a.$apply()})})};d()}]).directive("instanceOverview",["$rootScope","$compile","$http","$templateCache","$location","$stateParams",function(a,b,c,d,e){return{restrict:"A",replace:!0,link:function(a,f,g){var h,i=a.$eval(g.instanceOverview);a.$watch(function(){return e.path()},function(e){var g=e.split("/"),j=(g[1],g[2]);if(j&&j===i){if(h)return;c.get("views/overview.html",{cache:d}).then(function(c){f.html(c.data);var d=a.$new();h=d,b(f.contents())(d)})}else f.html(""),h&&(h.$destroy(),h=null)}),a.$on("$destroy",function(){})}}}]),angular.module("app.directive.loading",[]).directive("appLoading",["$rootScope","$parse",function(){return{restrict:"A",replace:!1,link:function(a,b,c){var d;a.$watch(function(){return a.$eval(c.appLoading)},function(a){"loading"==a?(d&&d.remove(),d=jQuery('<div class="data-loading"><p><i class="icon-logo1"></i>正在努力加载...</p></div>'),b.append(d)):"error"==a?(d&&d.remove(),d=jQuery('<div class="data-load-fault"><p><i class="icon-fault"></i><strong>加载失败</strong><button id="btn-refresh" class="btn-refresh">重新加载</button></p></div>'),b.append(d)):"done"==a&&d&&(d.remove(),d=null)});var e=function(b){b.preventDefault(),b.stopPropagation(),"btn-refresh"==b.target.getAttribute("id")&&(console.log("emit reload"),a.$emit("reload"))};b.bind("click",e),a.$on("$destroy",function(){b.unbind("click",e)})}}}]),angular.module("angular.directive.pull-to-refresh",[]).directive("pullToRefresh",["$rootScope","$timeout",function(a){return{restrict:"A",scope:{doLoad:"@",scroller:"@",max:"@",source:"@",remaining:"@",loadStatus:"@"},template:'<div id="pullToRefreshDiv" class="list-loadmore"></div>',replace:!1,link:function(b,c){var d=function(){c.show()},e=function(){c.hide()};e();var f=b.$parent.$watch(b.source,function(e){if(void 0!=e){f();var g=b.$parent.$eval(b.source),h=b.$parent.$eval(b.max),i=0,j=0,k=0,l=!1,m=document.querySelector(b.scroller);if(!g||g.length>=h)return void c.html("");var n=function(){console.log("scroll",l,b.loadStatus),l||k-m.scrollTop<=b.remaining&&(l=!0,a.$$phase?b.$parent.$eval(b.doLoad):b.$parent.$apply(b.doLoad))},o=b.$watch(function(){return g.length},function(a){h>a?(j=m.scrollHeight,i=m.clientHeight,k=j-i,l=!1,d(),n()):q()}),p=b.$parent.$watch(b.loadStatus,function(a,b){a!==b&&(l=!1,"error"==a?c[0].childNodes[0].innerHTML="加载失败，请重试。":"loading"==a&&(c[0].childNodes[0].innerHTML="正在努力加载..."))}),q=function(){o&&(o(),o=null),p&&(p(),p=null),m&&(m.removeEventListener("scroll",n),m=null),c.empty()};b.$on("$destroy",function(){q()}),m.addEventListener("scroll",n),d()}})}}}]),angular.module("app.directive.isroll",[]).directive("angularIscroll",function(){return{replace:!1,restrict:"A",scope:{config:"@",indicator:"@"},link:function(a,b){console.log("iscroll init");var c;c=new IScroll(b[0],{scrollX:!0,scrollY:!1,momentum:!1,snap:!0,tap:!0,eventPassthrough:!0,click:!1,snapSpeed:400,indicators:{el:document.querySelector(a.indicator),resize:!1}}),a.$on("$destroy",function(){c&&(c.destroy(),c=null)})}}}),angular.module("angular.directive.tap",[]).directive("angularTap",["$parse",function(a){return{compile:function(b,c){var d=a(c.angularTap);return function(a,b){b.on("tap",function(b){a.$apply(function(){d(a,{$event:b})})})}}}}]),angular.module("app.filter.instance",[]).constant("instanceStatus",{Pending:{cn:"待启动",level:"2"},Starting:{cn:"启动中",level:"2"},StartFailure:{cn:"启动失败",level:"1"},Shutted:{cn:"已停止",level:"2"},Shutting:{cn:"停止中",level:"2"},ShutFailure:{cn:"停止失败",level:"1"},Running:{cn:"运行中",level:"3"},Resetting:{cn:"重置中",level:"2"},ResetFailure:{cn:"重置失败",level:"1"},Released:{cn:"已释放",level:"0"},ChangePasswd:{cn:"更改密码中",level:"2"},Rollbacking:{cn:"快照回滚中",level:"2"},Updating:{cn:"升级中",level:"2"},Creating:{cn:"创建中",level:"2"},Expired:{cn:"已过期",level:"1"},CreateFailure:{cn:"创建失败",level:"1"},ChangeOS:{cn:"更换系统中",level:"2"},ChangePasswdFailure:{cn:"更换密码失败",level:"1"},RollbackFailure:{cn:"快照回滚失败",level:"1"},UpdateFailure:{cn:"配置升级失败",level:"1"},ChangeOSFailure:{cn:"更换系统失败",level:"1"},HouyiUpdating:{cn:"后羿升级中",level:"2"},ExpiredFailure:{cn:"到期失败",level:"1"},Locked:{cn:"已锁定",level:"0"},UnLocking:{cn:"解锁中",level:"2"}}).filter("chargeType",function(){return function(a){var b={AfterPay:"按量",Prepaid:"包年包月",MixPay:"混合付费",systemError:"异常",FreeTrial:"试用"};return b[a]||a}}).filter("statusIcon",["instanceStatus",function(a){return function(b){if(a[b])switch(a[b].level){case"0":return{"icon-ecs-gray":1};case"1":return{"icon-ecs-red":1};case"2":return{"icon-ecs-orange":1};case"3":return{"icon-ecs-green":1}}return null}}]).filter("statusColor",["instanceStatus",function(a){return function(b){if(a[b])switch(a[b].level){case"0":return{"text-gray":1};case"1":return{"text-red":1};case"2":return{"text-orange":1};case"3":return{"text-green":1}}return null}}]).filter("instanceStatus",["instanceStatus",function(a){return function(b){return a[b]?a[b].cn:b}}]),angular.module("app.tpl",["views/chart.html","views/detail.html","views/instances.html","views/main.html","views/overview.html"]),angular.module("views/chart.html",[]).run(["$templateCache",function(a){"use strict";a.put("views/chart.html",'<div class="full-chart" ng-style="fullChartStyle" app-loading="chart_loading"><label>磁盘监控 (30分钟)</label><div angular-highcharts="" config="fullChartConfig" render="chart_render"></div></div>')}]),angular.module("views/detail.html",[]).run(["$templateCache",function(a){"use strict";a.put("views/detail.html",'<div app-loading="detail_loading"><ul bindonce="ins" class="list" ng-if="detail_loading == \'done\'"><li class="item" bo-text="\'ID: \' + ins.instanceId"></li><li class="item" bo-html="\'名称: \' + ins.hostname"></li><li class="item">状态: <span bo-text="ins.status | instanceStatus"></span></li><li class="item" bo-text="\'CPU: \' + ins.cpu + \'核\'"></li><li class="item" bo-text="\'内存: \' + ins.memory"></li><li class="item" bo-text="\'数据盘: \' + ins.disk"></li><li class="item" bo-text="\'操作系统: \' + ins.osName"></li><li class="item" bo-text="\'公网IP: \' + ins.internetIp"></li><li class="item" bo-text="\'内网IP: \' + ins.intranetIp"></li><li class="item">带宽：2Mbsp</li></ul></div>')}]),angular.module("views/instances.html",[]).run(["$templateCache",function(a){"use strict";a.put("views/instances.html",'<div ui-view="chart" ng-show="$state.current.name == \'region.instance.chart\'" class="padding console-view view-chart"></div><div ui-view="detail" ng-show="$state.current.name == \'region.instance.detail\'" class="padding console-view view-detail"></div><div ng-if="!$state.includes(\'region.instance.*\')" class="padding console-view view-list" app-loading="loading"><div class="no-data" ng-if="loading == \'done\' && regions.list.length == 0"><p><strong>您暂时没有实例</strong></p></div><div ng-if="regions.list.length > 0"><div class="single-region" ng-if="regions.list.length == 1">您在{{regions.list[0].regionName}}有{{regions.list[0].ecs}}个实例</div><div class="button-bar" ng-if="regions.list.length != 1"><a bindonce="" ng-repeat="r in regions.list" class="button" bo-class="{ active: r.regionId == $stateParams.regionID }" bo-text="r.regionName + \' \' + r.ecs + \' 台\'" ng-click="$state.go(\'region\', { regionID: r.regionId })"></a></div><ul class="list"><li bindonce="" ng-repeat="ins in instances[$stateParams.regionID]" class="item"><div class="item-head" ng-click="toggle(ins)"><i class="icon icon-ecs-status" bo-class="ins.status | statusIcon"></i><div class="inst-name"><h2 bo-text="ins.instanceId"></h2><p><span class="text-gray" bo-text="ins.chargeType | chargeType"></span>， <span bo-html="getStatusInfo(ins)"></span></p></div><div class="inst-status" bo-class="ins.status | statusColor" bo-text="ins.status | instanceStatus"></div></div><div instance-overview="ins.instanceId"></div></li></ul><div pull-to-refresh="" source="instances[$stateParams.regionID]" max="instanceMax" scroller=".view-list" do-load="loadNext()" load-status="pullToRefreshLoadStatus" remaining="10"></div></div></div>')}]),angular.module("views/main.html",[]).run(["$templateCache",function(a){"use strict";a.put("views/main.html",'<div class="header"><ul class="nav nav-pills pull-right"><li class="active"><a ng-href="#">Home</a></li><li><a ng-href="#">About</a></li><li><a ng-href="#">Contact</a></li></ul><h3 class="text-muted">ecs</h3></div><div class="jumbotron"><h1>\'Allo, \'Allo!</h1><p class="lead"><img src="images/yeoman.png" alt="I\'m Yeoman"><br>Always a pleasure scaffolding your apps.</p><p><a class="btn btn-lg btn-success" ng-href="#">Splendid!</a></p></div><div class="row marketing"><h4>HTML5 Boilerplate</h4><p>HTML5 Boilerplate is a professional front-end template for building fast, robust, and adaptable web apps or sites.</p><h4>Angular</h4><p>AngularJS is a toolset for building the framework most suited to your application development.</p><h4>Karma</h4><p>Spectacular Test Runner for JavaScript.</p></div><div class="footer"><p>♥ from the Yeoman team</p></div>')}]),angular.module("views/overview.html",[]).run(["$templateCache",function(a){"use strict";a.put("views/overview.html",'<div class="item-content mini-chart" ng-controller="overviewController" app-loading="overview_loading"><div ng-show="overview_loading == \'done\'"><div class="viewport"><div class="wrapper" angular-iscroll="" indicator=".indicator-1"><div class="scroller"><div class="slide"><div class="painting"><div class="mini-chart-item" angular-tap="$state.go(\'.chart\', { chartType: \'cpu\' })"><label>CPU监控 (30分钟)</label><div angular-highcharts="" config="miniChartConfig.cpu" render="overview_render"></div></div></div></div><div class="slide"><div class="painting"><div class="mini-chart-item" angular-tap="$state.go(\'.chart\', { chartType: \'flow\' })"><label>网络监控 (30分钟)</label><div angular-highcharts="" config="miniChartConfig.flow" render="overview_render"></div></div></div></div><div class="slide"><div class="painting"><div class="mini-chart-item" angular-tap="$state.go(\'.chart\', { chartType: \'bps\' })"><label>磁盘监控 (30分钟)</label><div angular-highcharts="" config="miniChartConfig.bps" render="overview_render"></div></div></div></div></div></div></div><div class="indicator indicator-1"><div class="dotty"></div></div><a ng-click="$state.go(\'.detail\')" class="link-detail"><span class="icon-info-2"></span></a></div></div>')}]);